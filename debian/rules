#!/usr/bin/make -f

export PYBUILD_NAME = spicerack
export PYBUILD_TEST_PYTEST = 1

%:
	dh $@ --with python3 --buildsystem=pybuild

override_dh_auto_test:
	# Temporary hack as python3-phabricator doesn't ship the egg files, as a result setup.py doesn't find it.
	cp -av setup.py setup.py.orig
	sed -i '/phabricator/d' setup.py
	SETUPTOOLS_SCM_PRETEND_VERSION="$(shell dpkg-parsechangelog -S version | cut -d '+' -f 1)" python3 setup.py develop --user
	py.test-3 --strict --cov-report=term-missing --cov=spicerack spicerack/tests/unit
	# Undo the temporary hack
	mv -fv setup.py.orig setup.py

override_dh_auto_clean:
	# Skip the default dh_auto_clean

override_dh_installman:
	SETUPTOOLS_SCM_PRETEND_VERSION="$(shell dpkg-parsechangelog -S version | cut -d '+' -f 1)" python3 setup.py build_sphinx -b man
	sed -i='' -e 's/^\.B/.B /' doc/build/man/cookbook.1
	dh_installman
